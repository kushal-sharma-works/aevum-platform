services:
  mongodb:
    image: mongo:8.0
    container_name: aevum-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: decision_engine
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.adminCommand('ping').ok"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - aevum

  dynamodb-local:
    image: amazon/dynamodb-local:2.5.2
    container_name: aevum-dynamodb-local
    restart: unless-stopped
    command: ["-jar", "DynamoDBLocal.jar", "-sharedDb", "-dbPath", "/home/dynamodblocal/data"]
    volumes:
      - dynamodb_data:/home/dynamodblocal/data
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:8000/shell/ >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - aevum

  dynamodb-init:
    image: amazon/aws-cli:2.22.23
    container_name: aevum-dynamodb-init
    restart: "no"
    depends_on:
      dynamodb-local:
        condition: service_healthy
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "
      if aws dynamodb describe-table --endpoint-url http://dynamodb-local:8000 --region eu-central-1 --table-name aevum-events >/dev/null 2>&1; then
        echo 'DynamoDB table aevum-events already exists';
      else
        aws dynamodb create-table
          --endpoint-url http://dynamodb-local:8000
          --region eu-central-1
          --table-name aevum-events
          --attribute-definitions
            AttributeName=PK,AttributeType=S
            AttributeName=SK,AttributeType=S
            AttributeName=GSI1PK,AttributeType=S
            AttributeName=GSI1SK,AttributeType=N
            AttributeName=GSI2PK,AttributeType=S
          --key-schema
            AttributeName=PK,KeyType=HASH
            AttributeName=SK,KeyType=RANGE
          --global-secondary-indexes
            '[{"IndexName":"GSI1","KeySchema":[{"AttributeName":"GSI1PK","KeyType":"HASH"},{"AttributeName":"GSI1SK","KeyType":"RANGE"}],"Projection":{"ProjectionType":"ALL"}},{"IndexName":"GSI2","KeySchema":[{"AttributeName":"GSI2PK","KeyType":"HASH"}],"Projection":{"ProjectionType":"ALL"}}]'
          --billing-mode PAY_PER_REQUEST;
      fi
      "
    networks:
      - aevum

  event-timeline:
    build:
      context: ./services/event-timeline
      dockerfile: Dockerfile
    container_name: aevum-event-timeline
    restart: unless-stopped
    depends_on:
      dynamodb-init:
        condition: service_completed_successfully
    environment:
      AEVUM_LOG_LEVEL: info
      AEVUM_GIN_PORT: 8080
      AEVUM_ECHO_PORT: 9090
      AEVUM_DYNAMODB_ENDPOINT: http://dynamodb-local:8000
      AEVUM_DYNAMODB_TABLE: aevum-events
      AEVUM_AWS_REGION: eu-central-1
      AEVUM_JWT_SECRET: dev-local-secret
      AEVUM_OTEL_ENDPOINT: localhost:4317
      AEVUM_RATE_LIMIT_BURST: 100
      AEVUM_RATE_LIMIT_RATE: 50
    networks:
      - aevum

  decision-engine:
    build:
      context: ./services/decision-engine
      dockerfile: Dockerfile
    container_name: aevum-decision-engine
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
      event-timeline:
        condition: service_started
    environment:
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_ENVIRONMENT: Development
      MongoDB__ConnectionString: mongodb://mongodb:27017
      MongoDB__DatabaseName: decision_engine
      EventTimeline__BaseUrl: http://event-timeline:8080
      Observability__OtlpEndpoint: ""
    networks:
      - aevum

networks:
  aevum:
    driver: bridge

volumes:
  mongodb_data:
  dynamodb_data:
