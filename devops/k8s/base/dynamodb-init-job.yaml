apiVersion: batch/v1
kind: Job
metadata:
  name: dynamodb-init
  namespace: aevum-sit
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: init-table
          image: amazon/aws-cli:2.22.23
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              if aws dynamodb describe-table --endpoint-url http://dynamodb-local:8000 --region eu-central-1 --table-name aevum-events >/dev/null 2>&1; then
                echo "table exists"
                exit 0
              fi

              aws dynamodb create-table \
                --endpoint-url http://dynamodb-local:8000 \
                --region eu-central-1 \
                --table-name aevum-events \
                --attribute-definitions \
                  AttributeName=PK,AttributeType=S \
                  AttributeName=SK,AttributeType=S \
                  AttributeName=GSI1PK,AttributeType=S \
                  AttributeName=GSI1SK,AttributeType=N \
                  AttributeName=GSI2PK,AttributeType=S \
                --key-schema \
                  AttributeName=PK,KeyType=HASH \
                  AttributeName=SK,KeyType=RANGE \
                --global-secondary-indexes \
                  '[{"IndexName":"GSI1","KeySchema":[{"AttributeName":"GSI1PK","KeyType":"HASH"},{"AttributeName":"GSI1SK","KeyType":"RANGE"}],"Projection":{"ProjectionType":"ALL"}},{"IndexName":"GSI2","KeySchema":[{"AttributeName":"GSI2PK","KeyType":"HASH"}],"Projection":{"ProjectionType":"ALL"}}]' \
                --billing-mode PAY_PER_REQUEST
