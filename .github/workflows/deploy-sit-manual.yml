name: Deploy SIT (Manual)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Optional image tag override (default: current commit SHA)"
        required: false
        type: string

jobs:
  deploy-sit:
    name: Build and Deploy to SIT
    runs-on: ubuntu-latest
    environment: sit
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout selected branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-central-1

      - name: Login to ECR
        id: ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set deployment tag
        id: vars
        run: |
          TAG_INPUT="${{ github.event.inputs.image_tag }}"
          if [ -n "$TAG_INPUT" ]; then
            echo "tag=$TAG_INPUT" >> "$GITHUB_OUTPUT"
          else
            echo "tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push SIT images
        run: |
          REGISTRY="${{ steps.ecr.outputs.registry }}"
          TAG="${{ steps.vars.outputs.tag }}"

          docker build -t "$REGISTRY/aevum-event-timeline-sit:$TAG" -f services/event-timeline/Dockerfile services/event-timeline
          docker push "$REGISTRY/aevum-event-timeline-sit:$TAG"

          docker build -t "$REGISTRY/aevum-decision-engine-sit:$TAG" -f services/decision-engine/Dockerfile services/decision-engine
          docker push "$REGISTRY/aevum-decision-engine-sit:$TAG"

          docker build -t "$REGISTRY/aevum-query-audit-sit:$TAG" -f services/query-audit/Dockerfile services/query-audit
          docker push "$REGISTRY/aevum-query-audit-sit:$TAG"

          docker build -t "$REGISTRY/aevum-aevum-ui-sit:$TAG" -f frontend/aevum-ui/Dockerfile frontend/aevum-ui
          docker push "$REGISTRY/aevum-aevum-ui-sit:$TAG"

      - name: Configure kubectl for EKS
        run: |
          aws eks update-kubeconfig --name "${{ secrets.EKS_CLUSTER_NAME }}" --region eu-central-1

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.1

      - name: Deploy Event Timeline
        run: |
          helm upgrade --install event-timeline devops/helm/charts/event-timeline \
            -n aevum-sit --create-namespace \
            -f devops/helm/charts/event-timeline/values.yaml \
            -f devops/helm/charts/event-timeline/values-sit.yaml \
            --set image.repository="${{ steps.ecr.outputs.registry }}/aevum-event-timeline-sit" \
            --set image.tag="${{ steps.vars.outputs.tag }}"

      - name: Deploy Decision Engine
        run: |
          helm upgrade --install decision-engine devops/helm/charts/decision-engine \
            -n aevum-sit \
            -f devops/helm/charts/decision-engine/values.yaml \
            -f devops/helm/charts/decision-engine/values-sit.yaml \
            --set image.repository="${{ steps.ecr.outputs.registry }}/aevum-decision-engine-sit" \
            --set image.tag="${{ steps.vars.outputs.tag }}"

      - name: Deploy Query Audit
        run: |
          helm upgrade --install query-audit devops/helm/charts/query-audit \
            -n aevum-sit \
            -f devops/helm/charts/query-audit/values.yaml \
            -f devops/helm/charts/query-audit/values-sit.yaml \
            --set image.repository="${{ steps.ecr.outputs.registry }}/aevum-query-audit-sit" \
            --set image.tag="${{ steps.vars.outputs.tag }}"

      - name: Deploy Aevum UI
        run: |
          helm upgrade --install aevum-ui devops/helm/charts/aevum-ui \
            -n aevum-sit \
            -f devops/helm/charts/aevum-ui/values.yaml \
            -f devops/helm/charts/aevum-ui/values-sit.yaml \
            --set image.repository="${{ steps.ecr.outputs.registry }}/aevum-aevum-ui-sit" \
            --set image.tag="${{ steps.vars.outputs.tag }}"
